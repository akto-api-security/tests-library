id: WindowsCommandInjection
filter:
  or:
    - request_payload:
        regex:
          - (?i)\b(?:cmd\.exe|powershell\.exe|whoami|net\s+(?:user|localgroup|view|use)|tasklist|taskkill|ping|nslookup|ipconfig|reg(?:svr32)?|mshta|wscript|cscript|curl|wget|wmic|psexec|rundll32|schtasks|sc|explorer|del|dir|type|at\.exe)\b
    - query_param:
        regex:
          - (?i)\b(?:cmd\.exe|powershell\.exe|whoami|net\s+(?:user|localgroup|view|use)|tasklist|taskkill|ping|nslookup|ipconfig|reg(?:svr32)?|mshta|wscript|cscript|curl|wget|wmic|psexec|rundll32|schtasks|sc|explorer|del|dir|type|at\.exe)\b
    - request_headers:
        regex:
          - (?i)\b(?:cmd\.exe|powershell\.exe|whoami|net\s+(?:user|localgroup|view|use)|tasklist|taskkill|ping|nslookup|ipconfig|reg(?:svr32)?|mshta|wscript|cscript|curl|wget|wmic|psexec|rundll32|schtasks|sc|explorer|del|dir|type|at\.exe)\b

info:
  name: "Windows Command Injection"
  description: "Detects potential Windows command injection attempts in API requests by identifying known system commands often abused by attackers."
  details: "This rule targets abuse of Windows CLI tools like 'cmd', 'powershell', 'net user', 'ipconfig', etc. These commands are commonly used in post-exploitation, privilege escalation, and lateral movement. The regex is case-insensitive and includes optional `.exe` suffixes."
  impact: "Command injection could allow attackers to execute arbitrary commands on the host system, potentially leading to full system compromise, data exfiltration, or persistent access."
  category:
    name: "COMMAND_INJECTION"
    displayName: "Command Injection"
  subCategory: "Windows_Command"
  severity: HIGH