id: PROMO_CODE_EXPLOITATION
info:
  name: "Exploit Promo Codes by Stacking Them"
  description: |
    "This test evaluates whether the system properly handles the application of multiple promo codes to a single order. The goal is to identify vulnerabilities that could allow users to stack promo codes, resulting in unintended discounts and potential abuse of promotional offers."
  details: |
    "The test involves sending API requests with multiple promo codes to check if the system correctly validates and limits the application of discounts."
  impact: |
    "Allowing users to stack promo codes can lead to significant financial losses and undermine the effectiveness of promotional strategies. If users can apply multiple promo codes to a single order, they might receive excessive discounts, reducing the company's revenue and impacting the profitability of promotional campaigns. Ensuring strict validation and enforcement of promo code rules is essential to maintain fair pricing, protect revenue, and prevent the abuse of promotional offers."

  category:
    name: INPUT
    shortName: Input Validation
    displayName: Input Validation (INPUT)
  subCategory: PROMO_CODE_EXPLOITATION
  severity: LOW
  tags:
    - Business logic
    - OWASP top 10
    - HackerOne top 10
  references:
    - https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/
    - https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html
    - https://owasp.org/www-project-developer-guide/draft/design/web_app_checklist/validate_inputs/
  cwe:
    - CWE-20
  cve:
    - CVE-2018-20679
    - CVE-2019-14271
attributes:
  nature: INTRUSIVE
  plan: FREE
  duration: FAST
compliance_standards: compliance/input-validation.conf

api_selection_filters:
  response_code:
    gte: 200
    lt: 300
  method:
    neq: OPTIONS
  response_payload:
    length:
      gt: 0
    not_contains:
      - Error
      - Internal Server
      - Failed
      - Unauthorized
      - access denied
      - Forbidden
      - Method Not allowed
      - Gateway timeout
      - request timeout
      - server error
      - server busy
      - authentication error
      - authorization error
      - validation error
      - Permission Denied
      - invalid token
      - token expired
      - session expired
      - session timeout
      - unexpected error
      - unable to process request
      - bad request
      - service unavailable
      - account is locked
      - account is blocked
      - multiple failed attempts
    for_one:
      key:
        regex: "${probableOutputParameters}"
        extract: outputUserKey
      value:
        extract: outputUserValue
  request_payload:
    for_one:
      key:
        regex: "${probableInputParameters}"
        extract: userKey
      value:
        extract: userVal
wordLists:
  probableInputParameters:
    - promo
    - promos
    - promoCode
    - promoCodes
    - discountCode
    - discountCodes
    - coupon
    - coupons
    - couponCode
    - couponCodes
    - voucher
    - vouchers
    - offerCode
    - offerCodes
    - promoKey
    - promotionalCode

  probableOutputParameters:
    - discount
    - discountApplied
    - finalPrice
    - totalDiscount
    - discountPercentage
    - discountValue
    - priceAfterDiscount
    - appliedDiscount
    - totalPrice
    - amountAfterDiscount
    - netAmount
    - adjustedPrice
    - discountTotal

  codes:
    source: sample_data
    key:
      regex: promo|promos|promoCode|promoCodes|discountCode|discountCodes|coupon|coupons|couponCode|couponCodes|voucher|vouchers|offerCode|offerCodes|promoKey|promotionalCode
    location: payload

execute:
  type: single
  requests:
    - req:
        - modify_body_param:
            userKey: "${codes}, ${userVal}"

validate:
  response_code:
    gte: 200
    lt: 300
  response_payload:
    length:
      gt: 0
    not_contains:
      - Error
      - Internal Server
      - Failed
      - Unauthorized
      - access denied
      - Forbidden
      - Method Not allowed
      - Gateway timeout
      - request timeout
      - server error
      - server busy
      - authentication error
      - authorization error
      - validation error
      - Permission Denied
      - invalid token
      - token expired
      - session expired
      - session timeout
      - unexpected error
      - unable to process request
      - bad request
      - service unavailable
      - account is locked
      - account is blocked
      - multiple failed attempts
      - Attention Required!
      - CloudFlare
      - "Sorry, you have been blocked"
    for_one:
      key:
        eq: "${outputUserKey}"
      value:
        neq: "${outputUserValue}"
